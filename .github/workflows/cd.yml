name: cd

on:
  push:
    branches: [main]

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    env:
      DATABASE_URL: ${{ secrets.DATABASE_URL }}

    steps:
        - name: Check out code
          uses: actions/checkout@v4
        
        - name: Setup Go
          uses: actions/setup-go@v5
          with:
            go-version: "1.25.1"
      
        - name: Build Prod
          run: scripts/buildprod.sh

        - id: 'auth'
          uses: 'google-github-actions/auth@v2'
          with:
            credentials_json: '${{ secrets.GCP_CREDENTIALS }}'

        - name: 'Set up Cloud SDK'
          uses: 'google-github-actions/setup-gcloud@v3'

        - name: 'Use gcloud CLI'
          run: 'gcloud info'
        
        - name: Build docker and Push to Artifact Registry
          run: gcloud builds submit --tag europe-west10-docker.pkg.dev/key-scarab-473518-g8/notely-ar-repo/revmn/notely:latest .
        
        - name: Run Database Migration
          run: scripts/migrateup.sh 
        
        - name: Git Diff
          run: git diff HEAD

        - name: Deploy to Cloud Run
          run: gcloud run deploy notely --image europe-west10-docker.pkg.dev/key-scarab-473518-g8/notely-ar-repo/revmn/notely:latest --region europe-west10 --allow-unauthenticated --project key-scarab-473518-g8 --max-instances=4 
        